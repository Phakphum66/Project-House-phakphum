{% extends "base_admin.html" %}
{% load humanize %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-1 fw-bold text-dark">System Overview</h1>
        <p class="text-muted mb-0">Welcome back, {{ user.username }}. Here's what's happening today.</p>
    </div>
    <div class="d-flex gap-2">
        <a href="{% url 'quotes:list' %}" class="btn btn-outline-secondary">Manage Quotes</a>
        <a href="{% url 'construction:create' %}" class="btn btn-primary">New Project</a>
    </div>
</div>

<div class="row g-4 mb-4">
    <!-- Stat Cards -->
    <div class="col-12 col-md-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between mb-3">
                    <span class="text-muted text-uppercase small fw-bold">Pending Quotes</span>
                    <span class="badge bg-warning text-dark rounded-pill">Needs Review</span>
                </div>
                <h2 class="display-5 fw-bold text-dark mb-1">{{ pending_quotes_count }}</h2>
                <div class="text-muted small">Total quotes waiting for approval</div>
            </div>
        </div>
    </div>

    <div class="col-12 col-md-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between mb-3">
                    <span class="text-muted text-uppercase small fw-bold">Active Projects</span>
                    <span class="badge bg-success rounded-pill">Construction</span>
                </div>
                <h2 class="display-5 fw-bold text-dark mb-1">{{ projects|length }}</h2>
                <div class="text-muted small">Avg. Progress: {{ average_progress }}%</div>
                <div class="progress mt-3" style="height: 6px;">
                    <div class="progress-bar bg-success" role="progressbar" style="width: {{ average_progress }}%">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 col-md-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between mb-3">
                    <span class="text-muted text-uppercase small fw-bold">Inquiries</span>
                    <span class="badge bg-primary rounded-pill">New Leads</span>
                </div>
                <h2 class="display-5 fw-bold text-dark mb-1">{{ pending_estimate_inquiry_count|default:0 }}</h2>
                <div class="text-muted small">Unread messages from estimators</div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Main Activity Feed -->
    <div class="col-12 col-xl-8">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-bottom py-3">
                <h5 class="card-title mb-0 h6">Action Items & Inquiries</h5>
            </div>
            <div class="list-group list-group-flush">
                {% if pending_estimate_inquiries %}
                {% for inquiry in pending_estimate_inquiries %}
                <div class="list-group-item p-3">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="fw-semibold text-dark">{{ inquiry.name }}</div>
                            <div class="text-muted small">{{ inquiry.email }} • {{ inquiry.phone }}</div>
                            <div class="mt-1 small">
                                <span class="badge bg-light text-dark border me-1">Est: {{ inquiry.estimate_min|intcomma
                                    }} - {{ inquiry.estimate_max|intcomma }}</span>
                                <span class="text-muted">Size: {{ inquiry.house_size }}m²</span>
                            </div>
                        </div>
                        <div class="text-end">
                            <div class="small text-muted mb-1">{{ inquiry.submitted_at|date:"M d, H:i" }}</div>
                            <a href="{{ estimate_inquiry_admin_url }}" target="_blank"
                                class="btn btn-xs btn-outline-primary py-0" style="font-size: 0.75rem;">View</a>
                        </div>
                    </div>
                </div>
                {% endfor %}
                <div class="card-footer bg-white text-center border-0 p-3">
                    <a href="{{ estimate_inquiry_admin_url }}" target="_blank"
                        class="text-decoration-none small fw-bold">View All Inquiries</a>
                </div>
                {% else %}
                <div class="p-5 text-center text-muted">
                    No pending inquiries found.
                </div>
                {% endif %}
            </div>
        </div>

        <div class="card border-0 shadow-sm mt-4">
            <div class="card-header bg-white border-bottom py-3">
                <h5 class="card-title mb-0 h6">Active Construction Projects</h5>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="border-0 small text-uppercase text-muted fw-bold ps-4">Project Name</th>
                            <th class="border-0 small text-uppercase text-muted fw-bold">Client</th>
                            <th class="border-0 small text-uppercase text-muted fw-bold">Timeline</th>
                            <th class="border-0 small text-uppercase text-muted fw-bold">Progress</th>
                            <th class="border-0 small text-uppercase text-muted fw-bold text-end pe-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for project in projects|slice:":5" %}
                        <tr>
                            <td class="ps-4">
                                <div class="fw-semibold text-dark">{{ project }}</div>
                            </td>
                            <td>{{ project.owner.get_full_name|default:project.owner.username }}</td>
                            <td class="small text-muted">due {{ project.expected_end_date|date:"M d" }}</td>
                            <td style="width: 20%;">
                                <div class="d-flex align-items-center gap-2">
                                    <div class="progress flex-grow-1" style="height: 6px;">
                                        <div class="progress-bar bg-success"
                                            style="width:{{ project.total_progress }}%"></div>
                                    </div>
                                    <span class="small fw-semibold">{{ project.total_progress }}%</span>
                                </div>
                            </td>
                            <td class="text-end pe-4">
                                <a href="{% url 'construction:detail' project.pk %}"
                                    class="btn btn-sm btn-light">Manage</a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center py-4 text-muted">No active projects</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Sidebar / Recent Quotes -->
    <div class="col-12 col-xl-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-bottom py-3">
                <h5 class="card-title mb-0 h6">Recent Quote Requests</h5>
            </div>
            <div class="list-group list-group-flush">
                {% for quote in quotes|slice:":6" %}
                <div class="list-group-item p-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span
                            class="badge {% if quote.status == 'approved' %}bg-success{% elif quote.status == 'pending' %}bg-warning text-dark{% else %}bg-secondary{% endif %} rounded-pill"
                            style="font-size: 0.65rem;">
                            {{ quote.get_status_display }}
                        </span>
                        <small class="text-muted">{{ quote.created_at|date:"M d" }}</small>
                    </div>
                    <div class="fw-semibold text-dark mb-1">{{ quote.reference_name }}</div>
                    <div class="small text-muted mb-2">Ref: {{ quote.reference_code }}</div>
                    <a href="{% url 'quotes:detail' quote.pk %}" class="btn btn-sm btn-light w-100">Review Quote</a>
                </div>
                {% empty %}
                <div class="p-4 text-center text-muted">No recent quotes</div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}