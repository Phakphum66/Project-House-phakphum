{% extends "base.html" %}
{% block title %}ห้องสนทนาโครงการ{% endblock %}
{% block content %}
<div class="chat-layout">
    <div class="card chat-card border-0 shadow-sm">
        <div class="card-header bg-white d-flex align-items-center justify-content-between">
            <div>
                <h1 class="h5 mb-0 text-primary">สนทนาเกี่ยวกับ: {{ project }}</h1>
                <small class="text-muted">โครงการของคุณ: {{ conversation.customer.get_full_name|default:conversation.customer.username }}</small>
            </div>
            <a class="btn btn-outline-secondary" href="{% url 'construction:detail' project.pk %}">ย้อนกลับไปยังโครงการ</a>
        </div>
        <div class="card-body chat-body">
            <div id="chat-messages"
                 class="chat-messages"
                 hx-get="{% url 'chat:messages' conversation.pk %}"
                 hx-trigger="load, every 5s"
                 hx-target="#chat-messages"
                 hx-swap="outerHTML">
                {% include "chat/partials/message_items.html" with messages=messages %}
            </div>
        </div>
        <div class="card-footer bg-white">
            <form id="chat-form"
                  class="chat-form d-flex gap-2"
                  action="{% url 'chat:send' conversation.pk %}"
                  method="post"
                  hx-post="{% url 'chat:send' conversation.pk %}"
                  hx-trigger="submit"
                  hx-target="#chat-messages"
                  hx-swap="outerHTML">
                {% csrf_token %}
                <input type="text" name="content" class="form-control" placeholder="พิมพ์ข้อความ..." required>
                <button type="submit" class="btn btn-primary">
                    <span class="d-none d-md-inline">ส่ง</span>
                    <span class="d-md-none">→</span>
                </button>
            </form>
        </div>
    </div>
</div>
<script>
    document.addEventListener('htmx:afterSwap', function (event) {
        if (event.target && event.target.id === 'chat-messages') {
            event.target.scrollTop = event.target.scrollHeight;
            const requestConfig = event.detail && event.detail.requestConfig;
            if (requestConfig && requestConfig.verb === 'post') {
                const input = document.querySelector('#chat-form input[name="content"]');
                if (input) {
                    input.value = '';
                    input.focus();
                }
            }
        }
    });

    document.addEventListener('DOMContentLoaded', function () {
        const input = document.querySelector('#chat-form input[name="content"]');
        if (input) {
            input.focus();
        }
    });
</script>
{% endblock %}
